<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Match Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="privatematch.css">
</head>
<body>

    <div id="invitePopup">
        <div id="invitePopupContent">
            <div id="invitePopupHeader"></div>
            <div id="choiceButtons">
                <button id="acceptInvite">Accept</button>
                <button id="rejectInvite">Reject</button>
            </div>
        </div>
    </div>

    <!-- From Uiverse.io by NlghtM4re - also just a placeholder for the room creation animation for now-->     
    <div class="animationContainer">
        <div class="item" style="--i:0;"></div>
        <div class="item" style="--i:1;"></div>
        <div class="item" style="--i:2;"></div>
        <div class="item" style="--i:3;"></div>
        <div class="item" style="--i:4;"></div>
        <div class="item" style="--i:5;"></div>
        <div class="item" style="--i:6;"></div>
        <div class="item" style="--i:7;"></div>
        <div class="item" style="--i:8;"></div>
        <div class="item" style="--i:9;"></div>
        <div class="item" style="--i:10;"></div>
        <div class="item" style="--i:11;"></div>
        <div class="item" style="--i:12;"></div>
        <div class="item" style="--i:13;"></div>
        <div class="item" style="--i:14;"></div>
        <div class="item" style="--i:15;"></div>
        <div class="item" style="--i:16;"></div>
        <div class="item" style="--i:17;"></div>
        <div class="item" style="--i:18;"></div>
        <div class="item" style="--i:19;"></div>
        <div class="item" style="--i:20;"></div>
        <div class="loading-text">Creating room<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div>
    </div>

    <div id="privateMatch">
        <div id="playerContainer">
            <div id="playerTypingContainer">

            </div>
    
            <div id="playerKeyboard">
    
            </div>
        </div>

        <div id="progressLeaderboard">
            <h2 id="title">LEADERBOARD</h2>
            <h3 id="players"></h3> <!-- as in like every player's progress-->
        </div>
    </div>
    
    <div id="privateRoom">
        <button id="exitBtn" class="exit-btn">EXIT</button>
    
        <div id="left-sidebar">
            <div class="players-header">PLAYERS ()</div>
            <div id="playerList">
                </div>
            </div>
        </div>
        
        <div class="center-content">
            <div class="room-title">PRIVATE ROOM</div>
            
            <div id="roomId" class="room-id-display">Room ID:</div>
            
            <div class="invite-section">
                <div class="invite-title">INVITE PLAYER</div>
                <div class="invite-input-container">
                    <input type="text" id="inviteInput" placeholder="Enter username..." maxlength="20">
                    <button id="inviteBtn">INVITE</button>
                </div>
            </div>
            
            <div id="roomSettings">
                <div class="section-title">ROOM SETTINGS</div>
                
                <div class="setting-row">
                    <div class="setting-label">Word Count</div>
                    <select class="wordcount-select">
                        <option value="10">10 Words</option>
                        <option value="25" selected>25 Words</option>
                        <option value="50">50 Words</option>
                        <option value="100">100 Words</option>
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button id="startBtn" class = 'btn'>START MATCH</button>
                </div>
            </div>
        </div>
    </div>
    
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js"></script>
    <script>
        let myUsername = null;
        

        
        // Get username when page loads
        fetch('/auth/status')
            .then(res => res.json())
            .then(data => {
                if (data.authenticated && data.user) {
                    myUsername = data.user.displayName;
                    
                    // Request room data when page loads
                    if (roomId) {
                        socket.emit('joinPrivateRoom', {
                            privateRoomId: roomId,
                            playerName: myUsername
                        });
                    }
                }
            });

        

        // Check URL for room ID and display it
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const isRedirected = urlParams.get('redirected') === 'true';
        
        if (roomId) {
            document.getElementById('roomId').textContent = 'Room ID: ' + roomId;
            // Request current players in room
            socket.emit('getRoomPlayers', roomId);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const animationContainer = document.querySelector('.animationContainer');
            
            if (animationContainer) {
                if (isRedirected) {
                    // Skip animation if redirected from accepting invite
                    animationContainer.style.display = 'none';
                } else {
                    // Hide animation after 3 seconds with fade out (for room creators)
                    setTimeout(() => {
                        animationContainer.classList.add('fade-out');
                        setTimeout(() => {
                            animationContainer.style.display = 'none';
                        }, 1000); // Wait for fade transition to complete
                    }, 3000);
                }
            }
        });


        const inviteButton = document.getElementById('inviteBtn');
        const inviteInput = document.getElementById('inviteInput');

        inviteButton.addEventListener('click', () => {
            const username = inviteInput.value.trim();
            
            if (username.length >= 5 && myUsername) {
                socket.emit('invitePlayer', {
                    privateRoomId: roomId,
                    inviter: myUsername,
                    invitee: username
                });
                alert('Invitation sent to ' + username);
                inviteInput.value = '';
            }

            else if (username.length < 5 && username.length > 0) {
                alert('Please enter a valid username (at least 5 characters)');
            }

            else {
                alert('Please enter a username');
            }
        });

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', () => {
            // Get current player count
            const playerItems = document.querySelectorAll('.player-item');
            const playerCount = playerItems.length;
            
            if (playerCount < 2) {
                alert('You must have at least 2 players to start the match');
            }

            else {
                document.getElementById('privateRoom').style.display = 'none';
                document.getElementById('privateMatch').classList.add('active');
            }

        })

        // Handle player list updates
        socket.on('playerJoined', (data) => {
            updatePlayersList(data.players, data.playerCount);
        });

        function updatePlayersList(players, playerCount) {
            const playerList = document.getElementById('playerList');
            const playersHeader = document.querySelector('.players-header');
            
            // Update header with player count
            if (playersHeader) {
                playersHeader.textContent = `PLAYERS (${playerCount})`;
            }
            
            // Clear current list
            if (playerList) {
                playerList.innerHTML = '';
                
                // Add each player
                players.forEach(playerName => {
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    
                    const playerNameDiv = document.createElement('div');
                    playerNameDiv.className = 'player-name';
                    playerNameDiv.textContent = playerName;
                    
                    playerItem.appendChild(playerNameDiv);
                    playerList.appendChild(playerItem);
                });
            }
        }
    </script>
</body>
</html>