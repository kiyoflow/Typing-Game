<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Match Room</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="privatematch.css">
</head>
<body>

    <div id="invitePopup">
        <div id="invitePopupContent">
            <div id="invitePopupHeader"></div>
            <div id="choiceButtons">
                <button id="acceptInvite">Accept</button>
                <button id="rejectInvite">Reject</button>
            </div>
        </div>
    </div>

    <!-- From Uiverse.io by NlghtM4re - also just a placeholder for the room creation animation for now-->     
    <div class="animationContainer">
        <div class="item" style="--i:0;"></div>
        <div class="item" style="--i:1;"></div>
        <div class="item" style="--i:2;"></div>
        <div class="item" style="--i:3;"></div>
        <div class="item" style="--i:4;"></div>
        <div class="item" style="--i:5;"></div>
        <div class="item" style="--i:6;"></div>
        <div class="item" style="--i:7;"></div>
        <div class="item" style="--i:8;"></div>
        <div class="item" style="--i:9;"></div>
        <div class="item" style="--i:10;"></div>
        <div class="item" style="--i:11;"></div>
        <div class="item" style="--i:12;"></div>
        <div class="item" style="--i:13;"></div>
        <div class="item" style="--i:14;"></div>
        <div class="item" style="--i:15;"></div>
        <div class="item" style="--i:16;"></div>
        <div class="item" style="--i:17;"></div>
        <div class="item" style="--i:18;"></div>
        <div class="item" style="--i:19;"></div>
        <div class="item" style="--i:20;"></div>
        <div class="loading-text">Creating room<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div>
    </div>

    <div id="privateMatch">
        <countdown-component id="private-countdown"></countdown-component>
        <match-timer-component></match-timer-component>
        
        <div id="playerContainer">
            <div id="playerTypingContainer">

            </div>
    
            <keyboard-component></keyboard-component>
    
        </div>

        <div id="progressLeaderboard">
            <h2 id="title">LEADERBOARD</h2>
            <div id="players">
                
            </div><!-- as in like every player's progress-->
        </div>
    </div>
    
    <div id="privateRoom">
        <button id="exitBtn" class="exit-btn">EXIT</button>
    
        <div id="left-sidebar">
            <div class="players-header">PLAYERS ()</div>
            <div id="playerList">
                </div>
            </div>
        </div>
        
        <div class="center-content">
            <div class="room-title">PRIVATE ROOM</div>
            
            <div id="roomId" class="room-id-display">Room ID:</div>
            
            <div class="invite-section">
                <div class="invite-title">INVITE PLAYER</div>
                <div class="invite-input-container">
                    <input type="text" id="inviteInput" placeholder="Enter username..." maxlength="20">
                    <button id="inviteBtn">INVITE</button>
                </div>
            </div>
            
            <div id="roomSettings">
                <div class="section-title">ROOM SETTINGS</div>
                
                <div class="setting-row">
                    <div class="setting-label">Word Count</div>
                    <select class="wordcount-select">
                        <option value="10">10 Words</option>
                        <option value="25" selected>25 Words</option>
                        <option value="50">50 Words</option>
                        <option value="100">100 Words</option>
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button id="startBtn" class = 'btn'>START MATCH</button>
                </div>
            </div>
        </div>
    </div>
    
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="script.js"></script>
    <script src="keyboardComponent.js"></script>
    <script src="countdownComponent.js"></script>
    <script src="matchTimer.js"></script>
    <!-- <script src="debug_private_match.js"></script> -->
    <script>
        let myUsername = null;

        
        // Get username when page loads
        fetch('/auth/status')
            .then(res => res.json())
            .then(data => {
                if (data.authenticated && data.user) {
                    myUsername = data.user.displayName;
                    
                    // Request room data when page loads
                    if (privateRoomId) {
                        socket.emit('joinPrivateRoom', {
                            privateRoomId: privateRoomId,
                            playerName: myUsername
                        });
                    }
                }
            });

        

        // Check URL for room ID and display it
        const urlParams = new URLSearchParams(window.location.search);
        const privateRoomId = urlParams.get('room');
        const isRedirected = urlParams.get('redirected') === 'true';
        
        // Check if page was refreshed
        const isRefresh = performance.navigation.type === 1; // 1 means reload
        
        if (isRefresh && privateRoomId) {
            // If refreshed, leave the room and redirect to menu
            fetch('/auth/status')
                .then(res => res.json())
                .then(data => {
                    if (data.authenticated && data.user) {
                        socket.emit('leavePrivateRoom', { 
                            privateRoomId: privateRoomId, 
                            username: data.user.displayName 
                        });
                    }
                });
            alert('You have been removed from the room because you refreshed the page.');
            window.location.href = '/';

        } else if (privateRoomId) {
            document.getElementById('roomId').textContent = 'Room ID: ' + privateRoomId;
            // Request current players in room
            socket.emit('getRoomPlayers', privateRoomId);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const animationContainer = document.querySelector('.animationContainer');
            
            if (animationContainer) {
                if (isRedirected) {
                    // Skip animation if redirected from accepting invite
                    animationContainer.style.display = 'none';
                } else {
                    // Hide animation after 3 seconds with fade out (for room creators)
                    setTimeout(() => {
                        animationContainer.classList.add('fade-out');
                        setTimeout(() => {
                            animationContainer.style.display = 'none';
                        }, 1000); // Wait for fade transition to complete
                    }, 3000);
                }
            }
        });


        const inviteButton = document.getElementById('inviteBtn');
        const inviteInput = document.getElementById('inviteInput');

        inviteButton.addEventListener('click', () => {
            const username = inviteInput.value.trim();
            
            if (username.length >= 5 && myUsername) {
                socket.emit('invitePlayer', {
                    privateRoomId: privateRoomId,
                    inviter: myUsername,
                    invitee: username
                });
                alert('Invitation sent to ' + username);
                inviteInput.value = '';
            }

            else if (username.length < 5 && username.length > 0) {
                alert('Please enter a valid username (at least 5 characters)');
            }

            else {
                alert('Please enter a username');
            }
        });

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', () => {
            // Get current player count
            const playerItems = document.querySelectorAll('.player-item');
            const playerCount = playerItems.length;
            
            if (playerCount < 2) {
                alert('You must have at least 2 players to start the match');
            }

            else {
                // Get selected word count
                const selectedWordCount = document.querySelector('.wordcount-select').value;
                
                socket.emit('privateMatchStarted', { 
                    privateRoomId: privateRoomId,
                    wordCount: selectedWordCount 
                });
            }

        })

        // Handle player list updates
        socket.on('playerJoined', (data) => {
            updatePlayersList(data.players, data.playerCount);
        });

        // Handle player leaving
        socket.on('playerLeft', (data) => {
            updatePlayersList(data.players, data.playerCount);
            
            // Show notification if someone leaves during a match
            const privateMatch = document.getElementById('privateMatch');
            if (privateMatch.classList.contains('active')) {
                alert(`${data.username} left the match!`);
            }
        });

        socket.on('privateMatchStarted', (data) => {
            document.getElementById('privateRoom').style.display = 'none';
            document.getElementById('privateMatch').classList.add('active');
            document.getElementById('progressLeaderboard').style.display = 'block';
            
            // Initialize and show everything immediately (but disable typing)
            resetTypingVariables();
            displayRandomWords(data.words);
            
            // Show keyboard immediately but disable it
            setTimeout(() => {
                const keyboard = document.getElementById('keyboard');
                if (keyboard) {
                    keyboard.style.display = 'block';
                    keyboard.style.pointerEvents = 'none'; // Disable keyboard interactions
                    keyboard.style.opacity = '0.6'; // Visual indication it's disabled
                }
            }, 100);
            
            // Disable typing during countdown
            window.countdownActive = true;
            
            // Start countdown using the countdown component
            const countdown = document.getElementById('private-countdown');
            countdown.start(() => {
                // Re-enable typing after countdown
                window.countdownActive = false;
                
                // Re-enable keyboard
                const keyboard = document.getElementById('keyboard');
                if (keyboard) {
                    keyboard.style.pointerEvents = 'auto';
                    keyboard.style.opacity = '1';
                }
                
                // Start the progress timer for real-time leaderboard updates
                startPrivateMatchProgressTimer();
                
                // Start the 2-minute match timer
                const timer = document.querySelector('match-timer-component');
                if (timer) {
                    timer.startTimer();
                }
            });
        });

        // Handle EXIT button
        document.getElementById('exitBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to leave the room?')) {
                socket.emit('leavePrivateRoom', { privateRoomId: privateRoomId });
                window.location.href = '/';
            }
        });

        function updatePlayersList(players, playerCount) {
            const playerList = document.getElementById('playerList');
            const playersHeader = document.querySelector('.players-header');
            
            // Update header with player count
            if (playersHeader) {
                playersHeader.textContent = `PLAYERS (${playerCount})`;
            }
            
            // Clear current list
            if (playerList) {
                playerList.innerHTML = '';
                
                // Add each player
                players.forEach(playerName => {
                    const playerItem = document.createElement('div');
                    playerItem.className = 'player-item';
                    
                    const playerNameDiv = document.createElement('div');
                    playerNameDiv.className = 'player-name';
                    playerNameDiv.textContent = playerName;
                    
                    playerItem.appendChild(playerNameDiv);
                    playerList.appendChild(playerItem);
                });
            }
        }
    </script>
</body>
</html>